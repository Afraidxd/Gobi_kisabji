import importlib
import time
import random
import re
import asyncio
from html import escape

from telegram import InlineKeyboardButton, InlineKeyboardMarkup
from telegram import Update
from telegram.ext import CommandHandler, CallbackContext, MessageHandler, CallbackQueryHandler, filters

from shivu import collection,shivuu, top_global_groups_collection, group_user_totals_collection, user_collection, user_totals_collection
from shivu import application, LOGGER
from shivu.modules import ALL_MODULES


locks = {}
message_counters = {}
spam_counters = {}
last_characters = {}
sent_characters = {}
first_correct_guesses = {}
message_counts = {}

for module_name in ALL_MODULES:
    imported_module = importlib.import_module("shivu.modules." + module_name)


last_user = {}
warned_users = {}


def escape_markdown(text):
    escape_chars = r'\*_`\\~>#+-=|{}.!'
    return re.sub(r'([%s])' % re.escape(escape_chars), r'\\\1', text)


async def fav(update: Update, context: CallbackContext) -> None:
    user_id = update.effective_user.id

    if not context.args:
        await update.message.reply_text('ð™‹ð™¡ð™šð™–ð™¨ð™š ð™¥ð™§ð™¤ð™«ð™žð™™ð™š Slave ð™žð™™...')
        return

    character_id = context.args[0]

    user = await user_collection.find_one({'id': user_id})
    if not user:
        await update.message.reply_text('ð™”ð™¤ð™ª ð™ð™–ð™«ð™š ð™£ð™¤ð™© ð™‚ð™¤ð™© ð˜¼ð™£ð™® Slave ð™®ð™šð™©...')
        return

    character = next((c for c in user['characters'] if c['id'] == character_id), None)
    if not character:
        await update.message.reply_text('ð™ð™ð™žð™¨ slave ð™žð™¨ ð™‰ð™¤ð™© ð™„ð™£ ð™®ð™¤ð™ªð™§ list')
        return

    user['favorites'] = [character_id]

    await user_collection.update_one({'id': user_id}, {'$set': {'favorites': user['favorites']}})

    await update.message.reply_text(f'ðŸ¥³slave {character["name"]} is your favorite ð™£ð™¤ð™¬...')


def main() -> None:
    """Run bot."""

    

if __name__ == "__main__":
    shivuu.start()
    LOGGER.info("Bot started")
    main()